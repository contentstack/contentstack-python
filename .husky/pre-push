#!/usr/bin/env sh

echo "ğŸš€ Running pre-push checks..."

# Activate virtual environment if it exists
if [ -d "venv" ]; then
    echo "ğŸ”§ Activating virtual environment..."
    source venv/bin/activate
fi

# Run tests to ensure code quality
echo "ğŸ§ª Running tests..."
if ! pytest --html=tests/report/test-report.html; then
    echo "âŒ Tests failed. Please fix before pushing."
    exit 1
fi

# Run coverage check
echo "ğŸ“Š Checking test coverage..."
if ! pytest --cov=contentstack --cov-report=term-missing; then
    echo "âŒ Coverage check failed. Please improve test coverage."
    exit 1
fi

# Run security scan on dependencies (optional)
if [ -n "$SNYK_TOKEN" ]; then
    echo "ğŸ” Running comprehensive Snyk scan..."
    if ! snyk test --severity-threshold=high; then
        echo "âŒ High severity vulnerabilities found. Please fix before pushing."
        exit 1
    fi
fi

echo "âœ… All pre-push checks passed!"
